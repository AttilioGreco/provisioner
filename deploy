#!/bin/bash

set -x
set -e

source lib/helpers.sh

while [ $(get_current_quantity) -ne ${QUANTITY} ]; do

  QUANTITY_CURRENT=$(get_current_quantity)

  # The instance are increasing
  INCREASE=false
  if [ $QUANTITY_CURRENT -lt $QUANTITY ]; then
    QUANTITY_CURRENT=$(echo "$QUANTITY_CURRENT + 1" | bc)
    NEW_NUMBER=$(echo "$QUANTITY_CURRENT - 1" | bc)
    INCREASE=true
  fi

  # The instance are decreasing
  DECREASE=false
  if [ $QUANTITY_CURRENT -gt $QUANTITY ]; then
    QUANTITY_CURRENT=$(echo "$QUANTITY_CURRENT - 1" | bc)
    OLD_NUMBER="$QUANTITY_CURRENT"
    # Create cleanup task to the queue
    curl -sS -X PUT http://${CONSUL}:${CONSUL_PORT}/v1/kv/${CLUSTER_NAME}/${IDENTITY}/cleanup/${IDENTITY}-${OLD_NUMBER}
    DECREASE=true
  fi

  # Change infrastructure
  export QUANTITY_CURRENT
  source lib/apply.sh

  # If going down
  if [ "$DECREASE" == "true" ]; then
    # Ensure that cleanup task queue is empty
    until curl -f -sS -X DELETE http://${CONSUL}:${CONSUL_PORT}/v1/kv/${CLUSTER_NAME}/${IDENTITY}/cleanup/${IDENTITY}-${OLD_NUMBER}; do
      sleep 1
    done
  fi

  # Wait until consul quantity_current == get_current_quantity
  while [ $(get_current_quantity) -ne ${QUANTITY_CURRENT} ]; do
      echo "Wait until current quantity is increased"
      sleep 10
  done

  # If going up
  if [ "$INCREASE" == "true" ]; then
    # Wait until there is no issue in the node
    wait_health_ok ${IDENTITY}-${NEW_NUMBER}
  fi

  sleep 10

done
