#!/bin/bash

if [ "$DEBUG" = "true" ]; then
  set -x
fi
set -e

echo "$(date +%x\ %H:%M:%S) Start incremental deploy"

# Clean up old tasks
curl -f -sS -X DELETE "http://${CONSUL}:${CONSUL_PORT}/v1/kv/${CLUSTER_NAME}/${IDENTITY}/cleanup?recurse=yes"

source lib/helpers.sh
source lib/init.sh

while [ $(get_current_quantity) -ne ${QUANTITY} ]; do

  QUANTITY_CURRENT=$(get_current_quantity)

  # The instance are increasing
  INCREASE=false
  if [ $QUANTITY_CURRENT -lt $QUANTITY ]; then
    QUANTITY_CURRENT=$(echo "$QUANTITY_CURRENT + 1" | bc)
    NEW_NUMBER=$(echo "$QUANTITY_CURRENT - 1" | bc)
    INCREASE=true
    echo "$(date +%x\ %H:%M:%S) Create instance ${IDENTITY}-${NEW_NUMBER}"
  fi

  # The instance are decreasing
  DECREASE=false
  if [ $QUANTITY_CURRENT -gt $QUANTITY ]; then
    QUANTITY_CURRENT=$(echo "$QUANTITY_CURRENT - 1" | bc)
    OLD_NUMBER="$QUANTITY_CURRENT"
    # Create cleanup task to the queue
    curl -sS -X PUT http://${CONSUL}:${CONSUL_PORT}/v1/kv/${CLUSTER_NAME}/${IDENTITY}/cleanup/${IDENTITY}-${OLD_NUMBER} > /dev/null
    DECREASE=true
    echo "$(date +%x\ %H:%M:%S) Delete instance ${IDENTITY}-${OLD_NUMBER}"
  fi

  # Change infrastructure
  export QUANTITY_CURRENT
  source lib/apply.sh

  # If going down
  if [ "$DECREASE" == "true" ]; then
    # Ensure that cleanup task queue is empty
    until curl -f -sS -X DELETE http://${CONSUL}:${CONSUL_PORT}/v1/kv/${CLUSTER_NAME}/${IDENTITY}/cleanup/${IDENTITY}-${OLD_NUMBER} > /dev/null; do
      sleep 1
    done
  fi

  # If going up
  if [ "$INCREASE" == "true" ]; then
    # Wait until there is no issue in the node
    wait_health_ok ${IDENTITY}-${NEW_NUMBER}
  fi

  sleep 10

done

echo "$(date +%x\ %H:%M:%S) Incremental deploy ended"
