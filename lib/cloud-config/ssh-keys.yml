- name: generate ssh keys
  hosts: 127.0.0.1
  tags:
    - bootstrap
  tasks:
    - name: generate ssh keys
      shell: ssh-keygen -b 2048 -t rsa -f /tmp/id_rsa -q -N "" -P "{{ lookup('env','consul_encrypt') }}"
      args:
        creates: /tmp/id_rsa

    - name: put private ssh key
      uri:
        url: "http://{{ lookup('env', 'consul') }}:{{ lookup('env', 'consul_port') }}/v1/kv/kubernetes/{{ lookup('env', 'cluster_name') }}/custom_ssh_key"
        method: PUT
        status_code: 200
        body: "{{ lookup('file', '/tmp/id_rsa') }}"
      register: ssh_key_consul
      until: ssh_key_consul.failed == false
      delay: 1
      retries: 6000

    - name: put public ssh key
      uri:
        url: "http://{{ lookup('env', 'consul') }}:{{ lookup('env', 'consul_port') }}/v1/kv/kubernetes/{{ lookup('env', 'cluster_name') }}/custom_ssh_key_pub"
        method: PUT
        status_code: 200
        body: "{{ lookup('file', '/tmp/id_rsa.pub') }}"
      register: ssh_key_pub_consul
      until: ssh_key_pub_consul.failed == false
      delay: 1
      retries: 6000

    - name: remove keys from temp dir
      file:
        path: "{{ item }}"
        state: absent
      with_items:
        - /tmp/id_rsa
        - /tmp/id_rsa.pub

- name: spread ssh keys
  hosts: 127.0.0.1
  tasks:
    - name: get private ssh key
      uri:
        url: "http://{{ lookup('env', 'consul') }}:{{ lookup('env', 'consul_port') }}/v1/kv/kubernetes/{{ lookup('env', 'cluster_name') }}/custom_ssh_key"
        method: GET
        status_code: 200
        body_format: json
      register: ssh_key_consul
      until: ssh_key_consul.failed == false
      delay: 1
      retries: 6000
    - name: write private encrypted ssh key
      copy:
        content: "{{ ssh_key_consul.json[0] | json_query('Value') | b64decode }}"
        dest: /root/.ssh/id_rsa.enc
        mode: 0400
    - name: decrypt ssh keys
      shell: openssl rsa -in /root/.ssh/id_rsa.enc -out /root/.ssh/id_rsa -passin pass:{{ lookup('env', 'consul_encrypt') }} && chmod 400 /root/.ssh/id_rsa
      args:
        creates: /root/.ssh/id_rsa
    - name: get public ssh key
      uri:
        url: "http://{{ lookup('env', 'consul') }}:{{ lookup('env', 'consul_port') }}/v1/kv/kubernetes/{{ lookup('env', 'cluster_name') }}/custom_ssh_key_pub"
        method: GET
        status_code: 200
        body_format: json
      register: ssh_key_pub_consul
      until: ssh_key_pub_consul.failed == false
      delay: 1
      retries: 6000
    - name: write public ssh key
      copy:
        content: "{{ ssh_key_pub_consul.json[0] | json_query('Value') | b64decode }}"
        dest: /root/.ssh/id_rsa.pub
        mode: 0400
    - name: enable ssh key for direct root access
      authorized_key:
        user: root
        key: "{{ lookup('file', '/root/.ssh/id_rsa.pub') }}"
