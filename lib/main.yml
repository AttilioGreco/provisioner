#cloud-config

write_files:
  - content: |

      # TODO VARS HERE

      # TODO PLAYBOOK HERE

    path: /usr/src/cloud/playbook.yml
    permissions: '0400'

runcmd:
  - |
      bash <<'EOF'
      # Run main playbook
      export COMPLETED=false
      while [ "$COMPLETED" == "false" ]; do
        (
          cd /usr/src/cloud
          source venv/bin/activate
          export HOME=/root
          ansible-playbook -e ansible_python_interpreter=/usr/bin/python --connection=local playbook.yml
          git clone https://github.com/kubernetes-sigs/kubespray
          cd kubespray
          cp -ra inventory/sample inventory/mycluster
          cat << EOI > inventory/mycluster/hosts.ini
      [all]
      spray-0 ansible_host=spray-0.node.automium.consul etcd_member_name=etcd1
      spray-1 ansible_host=spray-1.node.automium.consul etcd_member_name=etcd2
      spray-2 ansible_host=spray-2.node.automium.consul etcd_member_name=etcd3

      [kube-master]
      spray-0
      spray-1
      spray-2

      [etcd]
      spray-0
      spray-1
      spray-2

      [kube-node]
      spray-0
      spray-1
      spray-2

      [k8s-cluster:children]
      kube-master
      kube-node
      EOI

          cat << EOA > ansible.cfg
      [ssh_connection]
      pipelining=True
      ssh_args = -o StrictHostKeyChecking=no -o ControlMaster=auto -o ControlPersist=30m -o ConnectionAttempts=100 -o UserKnownHostsFile=/dev/null
      #control_path = ~/.ssh/ansible-%%r@%%h:%%p
      [defaults]
      strategy_plugins = plugins/mitogen/ansible_mitogen/plugins/strategy

      host_key_checking=False
      gathering = smart
      fact_caching = jsonfile
      fact_caching_connection = /tmp
      stdout_callback = skippy
      library = ./library
      callback_whitelist = profile_tasks
      roles_path = roles:$VIRTUAL_ENV/usr/local/share/kubespray/roles:$VIRTUAL_ENV/usr/local/share/ansible/roles:/usr/share/kubespray/roles
      deprecation_warnings=False
      inventory_ignore_extensions = ~, .orig, .bak, .ini, .cfg, .retry, .pyc, .pyo, .creds
      [inventory]
      ignore_patterns = artifacts, credentials
      EOA

          mkdir callback_plugins
          pip install -r requirements.txt
          apt-get install bc -y
          export COUNT=${number}
          export NCOUNT=$(echo "$COUNT+1" | bc)
          export ANSIBLE_CONSUL_SERVER=${consul}
          export ANSIBLE_CONSUL_PATH="kubernetes/${name}/ansiblesync"
          #ansible-playbook -i inventory/mycluster/hosts.ini cluster.yml --limit node$NCOUNT -e ansible_python_interpreter=/usr/bin/python --connection=local

        ) >> /var/log/cloud-scripts.log 2>&1
        if [ $? == 0 ]; then
          COMPLETED=true
        fi
        sleep 1
      done
      export COMPLETED=false
      EOF
